\chapter{Experiments and Results}

\section{Bouncing Ball Test}
To give credibility to the approach mentioned in \autoref{sec:grid_htm}, a simple test case to test the capabilities of HTM and confirm that they apply on a video is introduced.
\subsection{Data}
\begin{figure}[H]
    \centering
    \includegraphics[width=.3\textwidth]{resources/experiments/bouncing_ball/bb_updown1.png}\hfill
    \includegraphics[width=.3\textwidth]{resources/experiments/bouncing_ball/bb_updownside.png}\hfill
    \includegraphics[width=.3\textwidth]{resources/experiments/bouncing_ball/bb_updown2.png}
    \caption{The bouncing ball test, and its three stages}
    \label{fig:bb}
\end{figure}
The video consists of a ball bouncing up and down until an anomaly occurs in the form of a sudden introduction of a horizontal velocity. After a while this horizontal velocity is set back to 0 and the ball is once again bouncing up and down in-place.
\par
\subsection{HTM}
The model used is a standard HTM model, which covers the entire input. This is equivalent to a single cell in a Grid HTM.
\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{resources/experiments/bouncing_ball/bb_anoms_bad.png}
    \caption{The 100-point moving average of the anomaly score in the bouncing ball experiment.}
\end{figure}
From the figure it can be observed that the HTM correctly detects anomalies and quickly adapts to them. On the other hand, the result is not perfect due to the minor oscillations close to $(1)$ and the anomaly spikes towards the end close to $(2)$. While the imperfections are not major and can be safely ignored, it is still important to understand their causes and what can be done to improve upon them. \par
\subsubsection{Boosting}
The reason for the oscillations is due to the spatial pooler being dominated by a lucky few columns. The solution is to enable boosting, as explained in \autoref{sec:spatial_pooler}. This also helped with the spikes towards the end, as can be seen in \autoref{fig:bb_boosting}.\par
\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{resources/experiments/bouncing_ball/bb_anoms_boosting.png}
    \caption{Bouncing ball with boosting enabled.}
    \label{fig:bb_boosting}
\end{figure}
\subsubsection{Zero Permanence Decrement}
The reason for the anomaly spikes towards the end is because the spatial pooler has found an optimal representation when the ball is bouncing freely, but when the ball stops and starts bouncing in-place the spatial pooler ends up unlearning the old optimal representation while it learns the new optimal representation. This causes a sudden minor change in the SP output, which the TM reports as anomalous.
\par
The solution is to set the value by which permanence is decreased by to zero, effectively disabling the ability of the spatial pooler to "forget", as can be seen in \autoref{fig:bb_forget}. That being said, the ability to decrement permanence is important in HTM systems, therefore disabling it is not always feasible.
\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{resources/experiments/bouncing_ball/bb_anoms_unforgetting.png}
    \caption{Bouncing ball without the ability of the SP to "forget".}
    \label{fig:bb_forget}
\end{figure}
\subsubsection{Boosting and Zero Permanence Decrement}
Finally, for the sake of interest, the bouncing ball test was performed with both boosting enabled and with zero permanence decrement. Results can be seen in \autoref{fig:bb_boosting_forget}.
\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{resources/experiments/bouncing_ball/bb_anoms_unforgetting_boosting.png}
    \caption{Bouncing ball without the ability of the SP to "forget" and with boosting enabled.}
    \label{fig:bb_boosting_forget}
\end{figure}
\subsubsection{Parameters}
Final list of parameters for reproducibility:
\begin{table}[H]
    \centering
    \begin{tabularx}{\linewidth}{@{}llX@{}}
        \toprule
        \textbf{Parameter} & \textbf{Value} & \textbf{Notes}                                      \\
        \midrule
        inputDimensions    & 120, 120       & The shape of the entire frame                       \\
        columnDimensions   & 60, 60         &                                                     \\
        potentialPct       & 0.1            &                                                     \\
        potentialRadius    & 120            &                                                     \\
        localAreaDensity   & 0.02           &                                                     \\
        globalInhibition   & True           & Set to False to enable topology                     \\
        wrapAround         & True           &
        Allows the columns near the edges to "wrap around" and form connections on the other side \\
        synPermActiveInc   & 0.1            &                                                     \\
        synPermInactiveDec & 0              & Set to \textgreater{}0 to enable the SP to "forget" \\
        stimulusThreshold  & 2              &                                                     \\
        seed               & 2              &                                                     \\
        boostStrength      & 0.1            & Set to 0 to disable boosting                        \\
        dutyCyclePeriod    & 250            &                                                     \\
        \bottomrule
    \end{tabularx}

    \caption{SP Parameters}
    \label{tab:bb_sp_params}
\end{table}
\begin{table}[H]
    \centering
    \begin{tabularx}{\linewidth}{@{}llX@{}}
        \toprule
        \textbf{Parameter}        & \textbf{Value} & \textbf{Notes} \\
        \midrule
        columnDimensions          & 60, 60         & Same as the SP \\
        predictedSegmentDecrement & 0.003          &                \\
        permanenceIncrement       & 0.1            &                \\
        permanenceDecrement       & 0.001          &                \\
        minThreshold              & 3              &                \\
        activationThreshold       & 5              &                \\
        cellsPerColumn            & 16             &                \\
        seed                      & 2              &                \\
        \bottomrule
    \end{tabularx}

    \caption{TM Parameters}
    \label{tab:bb_TM_params}
\end{table}
\subsection{Grid HTM}
This is a very simple problem which does not require invariances, making it unsuitable for Grid HTM. Grid HTM would be suitable if there were two or more independent bouncing balls, due to its improved invariance. Still, it is interesting to see how Grid HTM performs compared to normal HTM.
\subsubsection{Results}
\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{resources/experiments/bouncing_ball/bb_grid.png}
    \caption{Grid HTM}
\end{figure}
It can be observed that Grid HTM performs worse than the normal HTM, but the result is still acceptable. This is to be expected since this problem is not suited for the Grid HTM, and that the parameters given in \autoref{tab:bb_gridhtm_params}, \autoref{tab:bb_sp_gridhtm_param}, and \autoref{tab:bb_tm_gridhtm_param} are probably not optimal.
\subsubsection{Parameters}
The SP and TM parameters were selected so that they were as close as possible to the normal HTM parameters. The non-zero mean was chosen as the aggregation function, because there is no noisy due to the controlled environment.
\begin{table}[H]
    \centering
    \begin{tabularx}{\linewidth}{@{}XlX@{}}
        \toprule
        \textbf{Parameter} & \textbf{Value} & \textbf{Notes}                                                             \\
        \midrule
        sp\_grid\_size     & 30, 30         & Size of each grid                                                          \\
        tm\_grid\_size     & 15, 15         & Size of each SP grid output.                                               \\
        min\_sparsity      & 1              &                                                                            \\
        sparsity           & A              & Area of the bouncing ball with radius=3                                    \\
        temporal\_size     & 1              & Size of the multistep temporal pattern, 1 means it is effectively disabled \\
        \bottomrule
    \end{tabularx}
    \caption{Grid HTM specific parameters}
    \label{tab:bb_gridhtm_params}
\end{table}
\begin{table}[H]
    \centering
    \begin{tabularx}{\linewidth}{@{}XlX@{}}
        \toprule
        \textbf{Parameter} & \textbf{Value} & \textbf{Notes}                                                  \\
        \midrule
        inputDimensions    & sp\_grid\_size &                                                                 \\
        columnDimensions   & tm\_grid\_size &                                                                 \\
        potentialPct       & 0.5            & Increased in order to compensate for the smaller potential pool \\
        potentialRadius    & 5              &                                                                 \\
        localAreaDensity   & 0.1            &                                                                 \\
        globalInhibition   & True           & Set to False to enable topology                                 \\
        wrapAround         & False          &                                                                 \\
        synPermActiveInc   & 0.1            &                                                                 \\
        synPermInactiveDec & 0.001                                                                            \\
        stimulusThreshold  & 2              &                                                                 \\
        boostStrength      & 0              & Causes instability in empty cells                               \\
        \bottomrule
    \end{tabularx}
    \caption{SP Parameters}
    \label{tab:bb_sp_gridhtm_param}
\end{table}
\begin{table}[H]
    \centering
    \begin{tabularx}{\linewidth}{@{}XlX@{}}
        \toprule
        \textbf{Parameter}        & \textbf{Value} & \textbf{Notes} \\
        \midrule
        columnDimensions          & tm\_grid\_size & Same as the SP \\
        predictedSegmentDecrement & 0.003          &                \\
        permanenceIncrement       & 0.1            &                \\
        permanenceDecrement       & 0.001          &                \\
        minThreshold              & 1              &                \\
        activationThreshold       & 1              &                \\
        cellsPerColumn            & 16             &                \\
        \bottomrule
    \end{tabularx}
    \caption{TM Parameters}
    \label{tab:bb_tm_gridhtm_param}
\end{table}
\clearpage
\section{Surveillance example}
As stated earlier, one of the use cases of Grid HTM is anomaly detection in surveillance. This example will show how Grid HTM could perform.
The video to be used is part of the VIRAT\cite{VIRAT} video dataset, and was selected due to its long duration and stationary camera which can be seen in \autoref{fig:selected_frame}.
\par
The downside is that the video does not contain any non-technical anomalies, but consists of technical anomalies in the form of several segments with sudden frame skips in between. There is also a synthetic anomaly introduced in the form of a frame repeat lasting a couple of seconds, essentially "freezing" time, in order to test whether Grid HTM is able to understand how objects should be moving in time.
\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{resources/methodology/original.png}
    \includegraphics[width=0.8\textwidth]{resources/experiments/surveillance/parking_frame.png}
    \caption{Example frames from the selected video.}
    \label{fig:selected_frame}
\end{figure}
As previously mentioned, both binary thresholding and deep learning feature map extraction as encoders have their downsides. Therefore, this thesis proposes to use a combination of both, a segmentation model which can extract classes into their respective SDRs. Meaning that there could be an SDR for cars and an SDR for persons, that are then concatenated before being fed into the system.
\par
The segmentation model used is PointRend\cite{pointrend} with a ResNet101\cite{resnet} backbone, pretrained on ImageNet\cite{imagenet}, and implemented using PixelLib\cite{pixellib}.
\begin{figure}[H]
    \centering
    \includegraphics[width=0.45\textwidth]{resources/methodology/car_segmentation.png}
    \includegraphics[width=0.45\textwidth]{resources/methodology/person_segmentation.png}
    \caption{Example segmentation of cars and persons.}
\end{figure}
For the sake of simplicity, this experiment will focus only on the segmentation of cars.
\par
While on the topic of segmentation, it is important to mention that the segmentation model is not perfect and that there are cases where objects are misclassified as well as cases where cars repeatedly go above and below the confidence threshold.
\subsection{Parameters}
TODO
\subsection{Results}
\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{resources/experiments/surveillance/surveillance_result.png}
    \caption{Anomaly Scores.}
    \label{fig:surveillance_results}
\end{figure}
We can see in \autoref{fig:surveillance_results} that the Grid HTM is detecting when segments begin and end, however it is not possible to use a threshold value to isolate them, and they also have vastly different anomaly scores between each other. This is due to the way the aggregation function works, which means that the anomaly output is dependent on the physical size of the anomaly. \par
With that in mind, with the aggregation functions presented in this thesis, it is safe to conclude that looking at the anomaly score output is meaningless for complex data such as a surveillance video. This does not mean that Grid HTM is completely useless in that regard, and this can be observed by looking at the visual output of the Grid HTM. The visual output during which the first segment anomaly occurs can be seen in \autoref{fig:surveillance_segment}.
\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{resources/experiments/surveillance/surveillance_anomaly_1.png}
    \caption{The first segment anomaly, which is marked with red text,  and the corresponding changes detected by Grid HTM}
    \label{fig:surveillance_segment}
\end{figure}
\subsubsection{Road}
In the original video, there is a road on which cars regularly drive. By observing the visual output, it becomes evident that after some time the Grid HTM has mostly learned that behavior and does not report those moving cars as anomalies.
\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{resources/experiments/surveillance/surveillance_road_1.png}
    \caption{Road example}
\end{figure}
\subsubsection{Frame Repeat}
To prove that the Grid HTM has learned that cars on the road should be moving, it is possible to look at the visual output during the period when the video is repeating the same frame and observe if the system marks the cars standing still on the road as anomalies.
\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{resources/experiments/surveillance/surveillance_freeze_1.png}
    \caption{Anomaly output when the video is repeating a frame, the start of the frame repeat is marked with red text.}
\end{figure}
It can be observed that the cars along the main road are not marked as anomalies, but this could be attributed to the fact that there is a crossing there and that cars periodically have to stop at that point to let pedestrians cross.
\par
On the other hand, when looking at the anomaly marked with a red circle, the car on the road in the parking lot is marked as an anomaly that increases in severity as the time goes on during the frame repeat. The reason why that car causes an anomaly is because, unlike the cars on the main road, a car is rarely observed as standing still at that position.
\par
To prove that the anomaly was actually directly caused by the repeating frame, and not just due to repeating the anomaly in time, it should be compared to the anomaly output if there was no repeating frame.
\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{resources/experiments/surveillance/surveillance_freeze_3.png}
    \caption{Anomaly output when the video is not frozen in time, when the freeze should have occured is marked with red text.}
\end{figure}
We can see that the anomaly output is minor compared to when there was a repeating frame, proving that the anomaly was indeed a product of the repeating frame and that the Grid HTM was able to learn how objects should be moving in time.
\par
Finally, it is interesting to look at how the Grid HTM handles the repeating frames without multistep temporal patterns, which is shown in \autoref{fig:surveillance_freeze_3}.
\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{resources/experiments/surveillance/surveillance_freeze_2.png}
    \caption{Anomaly output when the video is not frozen in time, when the freeze should have occured is marked with red text.}
    \label{fig:surveillance_freeze_3}
\end{figure}
Unfortunately, simply disabling multistep temporal patterns without adjusting the other TM parameters causes the same car to be marked as an anomaly before and during the frame repeat. In fact, as mentioned in \autoref{sec:multistep_temporal_patterns}, disabling multistep temporal patterns causes Grid HTM to be less noise tolerant which causes a lot more anomalies to be wrongly detected.
\subsubsection{Points of Interest}
Finally, it is interesting to look the various anomaly score spikes and observe in the visual output what caused them. The points of interest to be explored are marked in \autoref{fig:surveillance_poi}
\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{resources/experiments/surveillance/surveillance_result_poi.png}
    \caption{Points of interests.}
    \label{fig:surveillance_poi}
\end{figure}
The first point of interest, which can be seen in TODO, showcases the weakness of the aggregation function.
single high anomaly
Due to the nature of moving average, since this anomaly lasts for a long time, it
\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{resources/experiments/surveillance/surveillance_poi_1.png}
    \caption{First}
\end{figure}
SECOND POI:
\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{resources/experiments/surveillance/surveillance_poi_2.png}
    \caption{Second}
\end{figure}
\clearpage
\section{Sperm example}
As seen in the surveillance example, it seems the Grid HTM can detect when segments begin and end. This experiment will explore this ability in greater detail.
\subsection{Data}
The dataset used is VISEM \cite{VISEM}, a sperm dataset which consists of videos that are made up of several segments. The sperm cells will be segmented using a rough binary thresholding.
\begin{figure}[H]
    \centering
    \includegraphics[width=.45\textwidth]{resources/experiments/sperm/sperm_example.png}
    \includegraphics[width=.45\textwidth]{resources/experiments/sperm/sperm_seg_example.png}
    \caption{Example frame from a sperm video and its corresponding segmentation.}
\end{figure}
It is important to note that the data itself is noisy, and that it is not possible for the Grid HTM to learn any meaningful pattern. The individual videos are also relatively short, which makes it even harder to learn any meaningful patterns.
\subsection{Benchmark}
To ensure that the HTM does not just react to the sudden change in pixels but does something more, the L1 error will be used as a benchmark to compare against:
\begin{align*}
    E_t=\sum|F_t-F_{t-1}|
\end{align*}
Where $F_t$ denotes a segmented frame at time step $t$. The L2 error could also have been used, but it would not matter since this experiment will be comparing relative values.
\subsection{Parameters}
For both results the following parameters were used:
\begin{table}[H]
    \centering
    \begin{tabularx}{\linewidth}{@{}XlX@{}}
        \toprule
        \textbf{Parameter} & \textbf{Value} & \textbf{Notes}                                                             \\
        \midrule
        sp\_grid\_size     & 16, 16         & Size of each grid                                                          \\
        tm\_grid\_size     & 8, 8           & Size of each SP grid output.                                               \\
        min\_sparsity      & 1              &                                                                            \\
        sparsity           & 5              &                                                                            \\
        temporal\_size     & 1              & Size of the multistep temporal pattern, 1 means it is effectively disabled \\
        \bottomrule
    \end{tabularx}
    \caption{Grid HTM specific parameters}
    \label{tab:sperm_params}
\end{table}
\begin{table}[H]
    \centering
    \begin{tabularx}{\linewidth}{@{}XlX@{}}
        \toprule
        \textbf{Parameter} & \textbf{Value} & \textbf{Notes}                    \\
        \midrule
        inputDimensions    & sp\_grid\_size &                                   \\
        columnDimensions   & tm\_grid\_size &                                   \\
        potentialPct       & 0.2            &                                   \\
        potentialRadius    & 5              &                                   \\
        localAreaDensity   & 0.1            &                                   \\
        globalInhibition   & False          &                                   \\
        wrapAround         & False          &                                   \\
        synPermActiveInc   & 0.01           &                                   \\
        synPermInactiveDec & 0.001                                              \\
        stimulusThreshold  & 5              &                                   \\
        boostStrength      & 0              & Causes instability in empty cells \\
        \bottomrule
    \end{tabularx}
    \caption{SP Parameters}
    \label{tab:sperm_sp_param}
\end{table}
\begin{table}[H]
    \centering
    \begin{tabularx}{\linewidth}{@{}XlX@{}}
        \toprule
        \textbf{Parameter}        & \textbf{Value} & \textbf{Notes} \\
        \midrule
        columnDimensions          & tm\_grid\_size & Same as the SP \\
        predictedSegmentDecrement & 0.003          &                \\
        permanenceIncrement       & 0.01           &                \\
        permanenceDecrement       & 0.001          &                \\
        minThreshold              & 1              &                \\
        activationThreshold       & 3              &                \\
        cellsPerColumn            & 16             &                \\
        \bottomrule
    \end{tabularx}
    \caption{TM Parameters}
    \label{tab:sperm_tm_param}
\end{table}
For the plots, a moving average with window size $n=100$ was used to smooth the lines and reduce noise. Because the data is noisy, the mean was used as the aggregation function.
\subsection{Results}
As seen in \autoref{fig:sperm_results1}, the Grid HTM is able to outperform the L1 error benchmark. This can be deduced from the more prominent spikes in the anomaly score, compared to the L1 error. The reason might be that even though the data is very noisy, there is still something in it which makes Grid HTM able to learn something general about the current state. This could for instance be a single cell that is standing still or moving very slowly, which the Grid HTM anchors itself to and uses it to determine when segments start and end.
\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{resources/experiments/sperm/sperm_result1.png}
    \caption{Results on a stationary sperm video.}
    \label{fig:sperm_results1}
\end{figure}

\par
That being said, the parameters for the Grid HTM were selected carefully to achieve the results seen in \autoref{fig:sperm_results1}, and are dependent on the contents of the data. Unfortunately, most of the videos in the dataset contain drift (in other words, the video is not stationary), which makes Grid HTM useless. This can be observed in \autoref{fig:sperm_results2}, where both the Grid HTM and the L1 error struggle.
\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{resources/experiments/sperm/sperm_result2.png}
    \caption{Results on a sperm video with drift.}
    \label{fig:sperm_results2}
\end{figure}
Just like in the stationary video, the spikes in the anomaly score are more pronounced, but due to the drift in the video there is a constant high anomaly output which makes it impossible to find a threshold value.
\section{Summary}